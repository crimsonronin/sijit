<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN"
	"http://www.w3.org/TR/html4/strict.dtd">
<html>
	<head>
		<title>Unit Testing Sds.AuthModule.AuthController</title>
		<style type="text/css">
			@import "../../../dojo/resources/dojo.css";
            @import "../../../dijit/themes/claro/claro.css";
            @import "../../../Sds/themes/claro/claro.css";
		</style>
		<script
            type="text/javascript"
            src="../../../dojo/dojo.js"
            data-dojo-config="
                isDebug: true,
                popup: true,
                async: true,
                mergeConfigs: [
                    'Sds/AuthModule/Config',
                    'Sds/Test/AuthModule/Asset/Config'
                ]
            ">
        </script>
		<script type="text/javascript">
			require([
                'doh/main',
                'dojo/_base/Deferred',
                'Sds/AuthModule/Exception/LoginFailedException',
                'Sds/AuthModule/Exception/AlreadyLoggedInException',
                'Sds/ServiceManager/Shared/GetObject!authController',
                'Sds/ServiceManager/Shared/GetObject!mockLoginInputAgent',
                'Sds/ServiceManager/Shared/GetObject!mockExceptionManager',
                'dojo/domReady!'
            ],
            function(
                doh,
                Deferred,
                LoginFailedException,
                AlreadyLoggedInException,
                authController,
                mockLoginInputAgent,
                mockExceptionManager
            ){

                // Define and register the tests
                doh.register([
                    function testLoginFail(){

                        var testResult = new Deferred();

                        mockLoginInputAgent.value.username = 'toby';
                        mockLoginInputAgent.value.password = 'wrong';

                        Deferred.when(authController.login(), null, function(){
                            doh.assertTrue(mockExceptionManager.lastException instanceof LoginFailedException);
                            testResult.resolve();
                        });

                        return testResult;
                    },

                    function testLoginSucceed(){

                        var testResult = new Deferred();

                        mockLoginInputAgent.value.username = 'toby';
                        mockLoginInputAgent.value.password = 'password';

                        Deferred.when(authController.login(), function(){
                            doh.assertTrue(authController.get('loggedIn'));
                            doh.assertEqual('toby', authController.get('activeUser'));
                            testResult.resolve();
                        });

                        return testResult;
                    },

                    function testAlreadyLoggedIn(){

                        var testResult = new Deferred();

                        mockLoginInputAgent.value.username = 'toby';
                        mockLoginInputAgent.value.password = 'password';

                        Deferred.when(authController.login(), null, function(){
                            doh.assertTrue(mockExceptionManager.lastException instanceof AlreadyLoggedInException);
                            testResult.resolve();
                        });

                        return testResult;
                    },

                    function testLogout(){

                        var testResult = new Deferred();

                        Deferred.when(authController.logout(), function(){
                            doh.assertFalse(authController.get('loggedIn'));
                            doh.assertFalse(authController.get('activeUser'));
                            testResult.resolve();
                        });

                        return testResult;
                    }
                ]);

                // Kick off the test runner
                doh.runOnLoad();
            })
		</script>
	</head>
	<body class="claro">
        <h1>Unit Testing Sds.AuthModule.AuthController</h1>
	</body>
</html>
